generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                 @id @default(cuid())
  email                   String                 @unique
  password                String
  role                    UserRole               @default(STUDENT)
  lastLogin               DateTime?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  refreshToken            String?
  emailVerificationExpiry DateTime?
  emailVerificationToken  String?                @unique
  emailVerified           Boolean                @default(false)
  passwordResetExpiry     DateTime?
  passwordResetToken      String?                @unique
  username                String                 @unique
  picture                 String?
  assessments             Assessment[]
  dailyProgress           DailyProgress[]
  examSessions            ExamSession[]
  exerciseUsage           ExerciseUsage[]
  learningSessions        LearningSession[]
  notifications           Notification[]
  studyGoals              StudyGoal[]
  submissions             Submission[]
  subscription            Subscription?
  levelProgress           UserLevelProgress?
  materialProgress        UserMaterialProgress[]
  profile                 UserProfile?
  weeklyProgress          WeeklyProgress[]
}

model UserLevelProgress {
  id                 String   @id @default(cuid())
  userId             String   @unique
  unlockedDifficulty Int      @default(2)
  difficulty1Points  Int      @default(0)
  difficulty2Points  Int      @default(0)
  difficulty3Points  Int      @default(0)
  difficulty4Points  Int      @default(0)
  difficulty5Points  Int      @default(0)
  pointsToUnlock3    Int      @default(100)
  pointsToUnlock4    Int      @default(200)
  pointsToUnlock5    Int      @default(300)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id])
}

model UserProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  examDate        DateTime?
  preferredTopics String[]
  studyStreak     Int       @default(0)
  totalPoints     Int       @default(0)
  level           Int       @default(1)
  averageScore    Float     @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id])
}

model Exercise {
  id                String             @id @default(cuid())
  type              ExerciseType
  category          Category
  epoch             LiteraryEpoch?
  difficulty        Int                @default(1)
  points            Int
  question          String
  content           Json
  correctAnswer     Json?
  rubric            Json?
  tags              String[]
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  work              String?
  aiUsage           AiUsage[]
  examQuestions     ExamQuestion[]
  usageHistory      ExerciseUsage[]
  spacedRepetitions SpacedRepetition[]
  submissions       Submission[]

  @@index([work])
  @@index([category, work])
}

model TextSource {
  id        String   @id @default(cuid())
  examId    String
  autor     String
  tytul     String
  fragment  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  exam      MockExam @relation(fields: [examId], references: [id])

  @@index([examId])
}

model Submission {
  id         String         @id @default(cuid())
  userId     String
  exerciseId String
  answer     Json
  score      Float?
  feedback   Json?
  assessedBy AssessmentType @default(SYSTEM)
  createdAt  DateTime       @default(now())
  timeSpent  Int?           @default(0)
  assessment Assessment?
  exercise   Exercise       @relation(fields: [exerciseId], references: [id])
  user       User           @relation(fields: [userId], references: [id])
}

model ExerciseUsage {
  id         String       @id @default(cuid())
  userId     String
  exerciseId String
  lastUsedAt DateTime     @default(now())
  usageCount Int          @default(1)
  context    UsageContext
  exercise   Exercise     @relation(fields: [exerciseId], references: [id])
  user       User         @relation(fields: [userId], references: [id])

  @@unique([userId, exerciseId])
  @@index([userId, lastUsedAt])
  @@index([exerciseId])
}

model ContentHub {
  id              String         @id @default(cuid())
  slug            String         @unique
  title           String
  type            HubType
  imageUrl        String?
  author          String?
  year            Int?
  genre           String?
  epoch           LiteraryEpoch?
  isRequired      Boolean        @default(false)
  birthYear       Int?
  deathYear       Int?
  period          String?
  metaTitle       String?
  metaDescription String?
  views           Int            @default(0)
  isPublished     Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  imageAlignment  String?        @default("full")
  imageWidth      String?        @default("100%")
  description     Json?
  pages           ContentPage[]

  @@index([type, isPublished])
  @@index([slug])
}

model ContentPage {
  id              String       @id @default(cuid())
  hubId           String
  slug            String
  title           String
  content         Json
  order           Int          @default(0)
  metaTitle       String?
  metaDescription String?
  readingTime     Int?
  views           Int          @default(0)
  isPublished     Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  averageRating   Float?       @default(0)
  ratingsCount    Int          @default(0)
  hub             ContentHub   @relation(fields: [hubId], references: [id], onDelete: Cascade)
  ratings         PageRating[]

  @@unique([hubId, slug])
  @@index([hubId, order])
}

model Assessment {
  id               String     @id @default(cuid())
  submissionId     String     @unique
  userId           String
  formalScore      Float?
  literaryScore    Float?
  compositionScore Float?
  languageScore    Float?
  totalScore       Float
  detailedFeedback Json
  improvements     String[]
  createdAt        DateTime   @default(now())
  submission       Submission @relation(fields: [submissionId], references: [id])
  user             User       @relation(fields: [userId], references: [id])
}

model SpacedRepetition {
  id          String   @id @default(cuid())
  userId      String
  exerciseId  String
  interval    Int      @default(1)
  easeFactor  Float    @default(2.5)
  repetitions Int      @default(0)
  nextReview  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  exercise    Exercise @relation(fields: [exerciseId], references: [id])

  @@unique([userId, exerciseId])
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId])
}

model Essay {
  id        String   @id @default(cuid())
  userId    String
  topic     String
  content   String
  wordCount Int
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  actionUrl String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, read])
}

model WeeklyProgress {
  id          String    @id @default(cuid())
  userId      String
  week        Int
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])

  @@unique([userId, week])
  @@index([userId])
}

model StudyGoal {
  id          String    @id @default(cuid())
  userId      String
  title       String
  description String?
  targetDate  DateTime
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model DailyProgress {
  id             String   @id @default(cuid())
  userId         String
  date           DateTime @db.Date
  exercisesCount Int      @default(0)
  studyTime      Int      @default(0)
  averageScore   Float?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId])
}

model LiteraryWork {
  id         String        @id @default(cuid())
  title      String
  author     String
  epoch      LiteraryEpoch
  genre      String
  year       Int?
  isRequired Boolean       @default(false)
  summary    String?
  themes     String[]
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  analyses   Analysis[]
  chapters   Chapter[]
  characters Character[]
  materials  Material[]
  quotes     Quote[]
}

model Chapter {
  id        String       @id @default(cuid())
  workId    String
  number    Int
  title     String
  summary   String
  keyEvents String[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  work      LiteraryWork @relation(fields: [workId], references: [id])

  @@unique([workId, number])
}

model Character {
  id          String       @id @default(cuid())
  workId      String
  name        String
  description String
  role        String
  traits      String[]
  evolution   String?
  quotes      String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  work        LiteraryWork @relation(fields: [workId], references: [id])
}

model Quote {
  id           String       @id @default(cuid())
  workId       String
  text         String
  context      String?
  character    String?
  chapter      Int?
  significance String?
  tags         String[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  work         LiteraryWork @relation(fields: [workId], references: [id])
}

model Analysis {
  id        String       @id @default(cuid())
  workId    String
  title     String
  type      AnalysisType
  content   String
  author    String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  work      LiteraryWork @relation(fields: [workId], references: [id])
}

model Material {
  id              String                 @id @default(cuid())
  title           String
  slug            String                 @unique
  type            MaterialType
  category        MaterialCategory
  content         Json
  summary         String?
  epoch           LiteraryEpoch?
  workId          String?
  tags            String[]
  difficulty      Int                    @default(1)
  readingTime     Int?
  isPremium       Boolean                @default(false)
  isPublished     Boolean                @default(true)
  views           Int                    @default(0)
  author          String?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  publishedAt     DateTime?
  work            LiteraryWork?          @relation(fields: [workId], references: [id])
  userProgress    UserMaterialProgress[]

  @@index([slug])
  @@index([category, epoch])
  @@index([isPublished, isPremium])
}

model EpochInfo {
  id                String        @id @default(cuid())
  epoch             LiteraryEpoch @unique
  name              String
  namePolish        String
  period            String
  characteristics   String[]
  philosophy        String
  artStyle          String
  mainGenres        String[]
  keyAuthors        String[]
  keyWorks          String[]
  historicalContext String
  timeline          Json
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model LiteraryTerm {
  id           String   @id @default(cuid())
  term         String   @unique
  category     String
  definition   String
  examples     String[]
  relatedTerms String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
}

model EssayTemplate {
  id        String   @id @default(cuid())
  title     String
  type      String
  structure Json
  tips      String[]
  examples  String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserMaterialProgress {
  id           String   @id @default(cuid())
  userId       String
  materialId   String
  completed    Boolean  @default(false)
  progress     Int      @default(0)
  lastAccessed DateTime @default(now())
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  material     Material @relation(fields: [materialId], references: [id])
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, materialId])
  @@index([userId])
}

model MockExam {
  id          String        @id @default(cuid())
  title       String
  year        Int?
  type        ExamType
  duration    Int
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  sections    ExamSection[]
  sessions    ExamSession[]
  textSources TextSource[]
}

model ExamSection {
  id          String         @id @default(cuid())
  examId      String
  order       Int
  title       String
  instruction String
  timeLimit   Int?
  questions   ExamQuestion[]
  exam        MockExam       @relation(fields: [examId], references: [id])

  @@unique([examId, order])
}

model ExamQuestion {
  id         String        @id @default(cuid())
  sectionId  String
  order      Int
  exerciseId String?
  type       ExerciseType?
  question   String?
  content    Json?
  points     Int
  exercise   Exercise?     @relation(fields: [exerciseId], references: [id])
  section    ExamSection   @relation(fields: [sectionId], references: [id])

  @@unique([sectionId, order])
}

model ExamSession {
  id            String       @id @default(cuid())
  userId        String
  examId        String
  startedAt     DateTime     @default(now())
  finishedAt    DateTime?
  timeSpent     Int?
  status        ExamStatus   @default(IN_PROGRESS)
  totalScore    Float?
  maxScore      Float?
  percentScore  Float?
  assessment    Json?
  isIntelligent Boolean?     @default(false)
  answers       ExamAnswer[]
  exam          MockExam     @relation(fields: [examId], references: [id])
  user          User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([examId])
}

model ExamAnswer {
  id          String      @id @default(cuid())
  sessionId   String
  questionId  String
  answer      Json
  score       Float?
  maxScore    Float
  submittedAt DateTime    @default(now())
  session     ExamSession @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, questionId])
}

model LearningSession {
  id                 String                @id @default(cuid())
  userId             String
  status             LearningSessionStatus @default(IN_PROGRESS)
  startedAt          DateTime              @default(now())
  lastActiveAt       DateTime              @default(now())
  finishedAt         DateTime?
  completed          Int                   @default(0)
  correct            Int                   @default(0)
  streak             Int                   @default(0)
  maxStreak          Int                   @default(0)
  points             Int                   @default(0)
  timeSpent          Int                   @default(0)
  filters            Json?
  completedExercises Json?
  skippedExercises   Json?
  user               User                  @relation(fields: [userId], references: [id])

  @@index([userId, status])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String             @unique
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  status                 SubscriptionStatus @default(INACTIVE)
  plan                   SubscriptionPlan   @default(FREE)
  aiPointsLimit          Int                @default(20)
  aiPointsUsed           Int                @default(0)
  aiPointsReset          DateTime           @default(now())
  startDate              DateTime?
  endDate                DateTime?
  cancelAt               DateTime?
  canceledAt             DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  isRecurring            Boolean            @default(true)
  metadata               Json?
  aiUsage                AiUsage[]
  pointsPurchases        PointsPurchase[]
  user                   User               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model AiUsage {
  id             String       @id @default(cuid())
  userId         String
  subscriptionId String
  exerciseId     String
  exerciseType   ExerciseType
  pointsCost     Int
  tokensUsed     Json
  success        Boolean      @default(true)
  errorMessage   String?
  createdAt      DateTime     @default(now())
  exercise       Exercise     @relation(fields: [exerciseId], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([userId, createdAt])
  @@index([subscriptionId])
  @@index([exerciseId])
}

model PageRating {
  id        String      @id @default(cuid())
  pageId    String
  userId    String?
  ipAddress String?
  rating    Int
  createdAt DateTime    @default(now())
  page      ContentPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([ipAddress])
}

model StripeEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  data          Json
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([stripeEventId])
}

model PointsPurchase {
  id              String       @id @default(cuid())
  userId          String
  subscriptionId  String
  pointsAmount    Int
  amountPaid      Int
  stripeSessionId String       @unique
  createdAt       DateTime     @default(now())
  subscription    Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([userId, createdAt])
  @@index([subscriptionId])
}

enum HubType {
  LITERARY_WORK
  EPOCH
  AUTHOR
  THEME
  GENRE
  GUIDE
}

enum UsageContext {
  LEARNING
  EXAM
  STUDY_PLAN
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum SubscriptionPlan {
  FREE
  PREMIUM
}

enum LearningSessionStatus {
  IN_PROGRESS
  COMPLETED
  PAUSED
}

enum ExamType {
  PODSTAWOWY
  ROZSZERZONY
}

enum ExamStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  TIMEOUT
}

enum MaterialType {
  EPOCH_OVERVIEW
  WORK_ANALYSIS
  CHARACTER_ANALYSIS
  THEME_ANALYSIS
  WRITING_GUIDE
  THEORY
  SUMMARY
  INTERPRETATION
  CONTEXT
  BIOGRAPHY
}

enum MaterialCategory {
  EPOCHS
  LITERATURE
  THEORY
  WRITING
  EXAM_PREP
  QUICK_REVIEW
}

enum AnalysisType {
  THEMES
  SYMBOLS
  STYLE
  INTERPRETATION
  CONTEXT
  COMPARISON
}

enum UserRole {
  STUDENT
  ADMIN
}

enum ExerciseType {
  CLOSED_SINGLE
  CLOSED_MULTIPLE
  SHORT_ANSWER
  SYNTHESIS_NOTE
  ESSAY
}

enum Category {
  LANGUAGE_USE
  HISTORICAL_LITERARY
  WRITING
}

enum LiteraryEpoch {
  ANTIQUITY
  MIDDLE_AGES
  RENAISSANCE
  BAROQUE
  ENLIGHTENMENT
  ROMANTICISM
  POSITIVISM
  YOUNG_POLAND
  INTERWAR
  CONTEMPORARY
}

enum AssessmentType {
  SYSTEM
  AI
}
